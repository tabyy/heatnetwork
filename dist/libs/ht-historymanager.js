!function(e,o,R){"use strict";var J="ht",d=e[J],V=d.Default,N=V.def,Y=V.getInternal();d.HistoryManager=function(j){this._histories=[],this.setDataModel(j)},N(d.HistoryManager,o,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var u=this;u._betweenTransaction++,1===u._betweenTransaction&&(u._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var O=this,z=O._histories;O._betweenTransaction>0&&O._betweenTransaction--,0===O._betweenTransaction&&(O._transactionHistories&&O._transactionHistories.length&&(z=z.slice(0,O._historyIndex+1),z.push(O._transactionHistories),z.length>O._maxHistoryCount&&(z=z.slice(z.length-O._maxHistoryCount)),O.setHistories(z),O.setHistoryIndex(z.length-1,!0)),delete O._transactionHistories)}},setDataModel:function(S){var p=this,X=p._dataModel;X!==S&&(X&&(delete X._historyManager,X.ump(p.handleDataModelPropertyChange,p),X.umm(p.$5p,p),X.umd(p.$6p,p),X.removeHierarchyChangeListener(p.handleHierarchyChange,p),X.removeIndexChangeListener(p.handleIndexChange,p)),p._dataModel=S,S&&(S._historyManager=p,S.mp(p.handleDataModelPropertyChange,p),S.mm(p.$5p,p),S.md(p.$6p,p),S.addHierarchyChangeListener(p.handleHierarchyChange,p),S.addIndexChangeListener(p.handleIndexChange,p)),p.fp("dataModel",X,S),p.clear())},setHistoryIndex:function(l,d){var L=this,O=L._historyIndex,R=L._histories.length;if(-1>l?l=-1:l>=R&&(l=R-1),O!==l){if(!d){var g=l-O;g>0?L.$2p(g):0>g&&L.$1p(-g)}L._historyIndex=l,L.fp("historyIndex",O,l),L.dataModel&&L.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(u){var $=this,J=$._histories,L=$._maxHistoryCount;(!u||0>=u)&&(u=10),L!==u&&($._maxHistoryCount=u,$.fp("maxHistoryCount",L,u),J.length>u&&$.clear())},cloneValue:function(n){return d.Default.clone(n)},isPropertyUndoable:function(T){return T&&!this.ignoredPropertyMap[T]},isDataModelPropertyUndoable:function(Q){return Q&&!this.ignoreDataModelPropertyMap[Q]},$5p:function(N){this.handleChange(N,N.kind)},$6p:function(D){this.handleChange(D,"property")},handleHierarchyChange:function(h){this.handleChange(h,"hierarchy")},handleIndexChange:function(n){this.handleChange(n,"index")},handleDataModelPropertyChange:function($){this.handleChange($,"dataModelProperty")},toChildrenInfo:function(z){var j={};return j.data=z,j.children=[],z.eachChild(function(K){j.children.push(this.toChildrenInfo(K))},this),j},restoreChildren:function(K){var J=K.data;K.children.forEach(function(K){var R=K.data;R.getParent()!==J&&J.addChild(R),this._dataModel.contains(R)||this._dataModel.add(R),this.restoreChildren(K)},this)},handleChange:function(A,O){var Q=this;if(!(Q._disabled||Q._isUndoRedoing||V.loadingRefGraph)){var $,g=(Q._histories,A.data),s=A.property;if(!g||!(g._refGraph||g instanceof d.RefGraph)){if("property"===O)Q.isPropertyUndoable(s,g)&&($={kind:O,data:g,property:s,oldValue:Q.cloneValue(A.oldValue,g,s),newValue:Q.cloneValue(A.newValue,g,s),event:A});else if("hierarchy"===O||"index"===O)$={kind:O,data:g,oldIndex:A.oldIndex,newIndex:A.newIndex,event:A};else if("clear"===O)$={kind:O,json:A.json,event:A};else if("add"===O){if($={kind:O,data:g,event:A,childrenInfo:this.toChildrenInfo(g),parent:g.getParent()},$.parent){var p=Q._dataModel.getSiblings(g);$.siblingsIndex=p.indexOf(g)}g instanceof d.Node&&($.host=g.getHost(),$.attaches=g.getAttaches()?g.getAttaches().toArray():R),g instanceof d.Edge&&($.source=g.getSource(),$.target=g.getTarget())}else"remove"===O?$={kind:O,data:g,event:A}:"dataModelProperty"===O&&Q.isDataModelPropertyUndoable(s,g)&&($={kind:O,property:s,oldValue:Q.cloneValue(A.oldValue,g,s),newValue:Q.cloneValue(A.newValue,g,s),event:A});Q.addHistory($)}}},addHistory:function(C){var P=this;if(C)if(P._betweenTransaction){var g=!1;if("property"===C.kind||"dataModelProperty"===C.kind)for(var i=P._transactionHistories.length-1;i>=0;i--){var J=P._transactionHistories[i];if(C.kind===J.kind&&C.property===J.property&&C.data===J.data){C.oldValue=J.oldValue,P._transactionHistories[i]=C,g=!0;break}}g||P._transactionHistories.push(C)}else{var A=P._histories;A=A.slice(0,P._historyIndex+1),A.push([C]),A.length>P._maxHistoryCount&&(A=A.slice(A.length-P._maxHistoryCount)),P.setHistories(A),P.setHistoryIndex(A.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(U){(!U||0>=U)&&(U=1),this.setHistoryIndex(this._historyIndex-U)},$1p:function(f){if(this.canUndo()){var G,v=this,N=v._dataModel,b=v._histories,s=v._historyIndex,X=0;for(v._isUndoRedoing=!0,V.setIsolating(!0);f>0;){if(s>=0&&s<b.length){X++,G=b[s],s--;for(var x=G.length-1;x>=0;x--){var W=G[x],Q=W.kind,A=W.data,S=W.property,D=W.event,h=this.cloneValue(W.oldValue,A,S);if(W.undo)W.undo();else if("add"===Q)N.remove(A,{keepChildren:!0});else if("remove"===Q)N.contains(A)||N.add(A,D.rootsIndex,D.datasIndex);else if("clear"===Q)N.deserialize(V.clone(W.json));else if("property"===Q)if("parent"===S)h?h.addChild(A,D.oldIndex):(A.setParent(h),D.oldIndex>=0&&N.moveTo(A,D.oldIndex));else{var l=null;0===S.indexOf("a:")?(l="attr",S=S.replace("a:","")):0===S.indexOf("s:")?(l="style",S=S.replace("s:","")):0===S.indexOf("f:")&&(l="field",S=S.replace("f:","")),Y.setPropertyValue(A,l,S,h)}else if("dataModelProperty"===Q){var l=null;0===S.indexOf("a:")?(l="attr",S=S.replace("a:","")):0===S.indexOf("s:")?(l="style",S=S.replace("s:","")):0===S.indexOf("f:")&&(l="field",S=S.replace("f:","")),Y.setPropertyValue(N,l,S,h)}else"hierarchy"===Q?N.moveTo(A,W.oldIndex):"index"===Q&&N.moveToIndex(A,W.oldIndex)}}f--}V.setIsolating(!1),delete v._isUndoRedoing,v.afterUndo(X)}},afterUndo:function(){},redo:function(G){(!G||0>=G)&&(G=1),this.setHistoryIndex(this._historyIndex+G)},$2p:function(t){if(this.canRedo()){var u,J=this,h=J._dataModel,Q=J._histories,j=J._historyIndex,_=0;for(J._isUndoRedoing=!0,V.setIsolating(!0);t>0;){if(j>=-1&&j<Q.length-1){_++,j++,u=Q[j];for(var K=0;K<u.length;K++){var X=u[K],G=X.kind,a=X.data,D=X.property,R=X.event,r=this.cloneValue(X.newValue,a,D);if(X.redo)X.redo();else if("add"===G)X.parent&&!a.getParent()&&X.parent.addChild(a,X.siblingsIndex),h.contains(a)||h.add(a,R.rootsIndex,R.datasIndex),this.restoreChildren(X.childrenInfo),a instanceof d.Node&&(a.setHost(X.host),X.attaches&&X.attaches.forEach(function(C){C.setHost(a)})),a instanceof d.Edge&&(a.setSource(X.source),a.setTarget(X.target));else if("remove"===G)h.remove(a);else if("clear"===G)h.clear();else if("property"===G)if("parent"===D)r?r.addChild(a,R.newIndex):(a.setParent(r),R.newIndex>=0&&h.moveTo(a,R.newIndex));else{var x=null;0===D.indexOf("a:")?(x="attr",D=D.replace("a:","")):0===D.indexOf("s:")?(x="style",D=D.replace("s:","")):0===D.indexOf("f:")&&(x="field",D=D.replace("f:","")),Y.setPropertyValue(a,x,D,r)}else if("dataModelProperty"===G){var x=null;0===D.indexOf("a:")?(x="attr",D=D.replace("a:","")):0===D.indexOf("s:")?(x="style",D=D.replace("s:","")):0===D.indexOf("f:")&&(x="field",D=D.replace("f:","")),Y.setPropertyValue(h,x,D,r)}else"hierarchy"===G?h.moveTo(a,X.newIndex):"index"===G&&h.moveToIndex(a,X.newIndex)}}t--}V.setIsolating(!1),delete J._isUndoRedoing,this.afterRedo(_)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);